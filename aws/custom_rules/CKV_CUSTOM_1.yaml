metadata:
  name: "Ensure Postgres RDS as aws_db_instance has AUDIT enabled"
  id: "CKV_CUSTOM_1"
  severity: "HIGH"
  category: "LOGGING"
definition:
  or:
    - cond_type: filter
      attribute: resource_type
      value:
        - aws_db_instance
      operator: within
    - cond_type: connection
      resource_types:
        - aws_db_instance
      connected_resource_types:
        - aws_db_parameter_group
      operator: exists
    - cond_type: attribute
      resource_types:
        - aws_db_parameter_group
      attribute: "parameter.*.name"
      operator: contains
      value: "shared_preload_libraries"
    - cond_type: attribute
      resource_types:
        - aws_db_parameter_group
      attribute: "parameter.*.name"
      operator: contains
      value: "pgaudit.log"
    - cond_type: attribute
      resource_types:
        - aws_db_parameter_group
      attribute: "parameter.*.name"
      operator: contains
      value: "pgaudit.log_catalog"
    - cond_type: attribute
      resource_types:
        - aws_db_parameter_group
      attribute: "parameter.*.name"
      operator: contains
      value: "log_connections"
      value: "on"
